= Administrationshandbuch: Nextcloud-Installation
:toc: left
:toclevels: 4
:sectnums:

== 1. Serverübersicht und Zugänge

=== 1.1. Testumgebung (Lokal via UTM)
* **Virtualisierung:** UTM auf macOS (Apple Silicon)
* **Hostname:** ozbek 
* **IP-Adresse (Shared):** 192.168.64.2 (via DHCP)
* **Betriebssystem:** Ubuntu 24.04 LTS (ARM64)
* **Netzwerk-Modus:** Shared (Internetzugriff via NAT)

=== 1.2. Notfall-Übergabeprozess
// Prozessbeschreibung für den Notfall [cite: 167]

== 2. Grundlegende Servereinrichtung

=== 2.1. Systemaktualisierung
Nach Behebung der DNS-Probleme (Hinzufügen von Nameservern in Netplan) wurde das System auf den neuesten Stand gebracht.

[source,bash]
----
sudo apt update && sudo apt upgrade -y
----

=== 2.2. Systembenutzer 'nextcloud'
Ein dedizierter Systembenutzer `nextcloud` ohne Root-Rechte wurde erstellt[cite: 115].

[source,bash]
----
sudo adduser nextcloud
----

=== 2.3. Firewall-Konfiguration (ufw)
ufw wurde aktiviert. Der SSH-Zugriff wurde auf den UTM-Gateway (Host-Mac) beschränkt. HTTP/HTTPS-Ports wurden für den Dienst geöffnet.

[source,bash]
----
# IP 192.168.64.1 ist der Gateway im "Shared" Modus von UTM
sudo ufw allow from 192.168.64.1 to any port 22 proto tcp
sudo ufw allow http
sudo ufw allow https
sudo ufw enable
----

== 3. LAMP/LEMP-Stack Installation

Dieser Abschnitt beschreibt die Installation des "LEMP" Stacks (Linux, Nginx, MariaDB, PHP), der als Grundlage für Nextcloud dient. Vor der Installation der Pakete war ein `sudo apt update` notwendig, um die Paketlisten zu synchronisieren.

=== 3.1. Webserver (Nginx)
Nginx wurde als leistungsstarker Webserver gewählt.

[source,bash]
----
sudo apt update
sudo apt install nginx -y
----
Nach der Installation war die Standard-Willkommensseite von Nginx unter `http://192.168.64.2` im Host-Browser erreichbar.

=== 3.2. Datenbank (MariaDB)
MariaDB wurde als Datenbankserver installiert.

[source,bash]
----
sudo apt install mariadb-server -y
----
Unmittelbar nach der Installation wurde das `mysql_secure_installation`-Skript ausgeführt, um ein Root-Passwort festzulegen und die Standardeinstellungen abzusichern.

=== 3.3. PHP-FPM und Erweiterungen
PHP-FPM (Version 8.3 auf Ubuntu 24.04) und alle von Nextcloud benötigten Erweiterungen  wurden installiert.

[source,bash]
----
sudo apt install php8.3-fpm php8.3-mysql php8.3-curl \
                 php8.3-gd php8.3-imagick php8.3-mbstring \
                 php8.3-xml php8.3-zip php8.3-intl \
                 php8.3-bz2 php8.3-opcache -y
----

=== 3.4. PHP-Parameter Optimierung
// Dieser Abschnitt wird in einer späteren Phase ausgefüllt.

== 4. Nextcloud-Installation und Konfiguration

=== 4.1. Download und Verzeichnis setup
// Befehle für wget, tar und Verzeichniserstellung [cite: 125]
// Pfad: /var/www/nextcloud [cite: 121, 125]

=== 4.2. Eigentümer- und Dateirechte
// chown und chmod Befehle zur Absicherung [cite: 126, 127, 128]

=== 4.3. Webserver-Konfiguration (Virtual Host / Server Block)
// Inhalt der .conf Datei für Nginx/Apache hier einfügen [cite: 121]

=== 4.4. Web-Installer
// Schritte zur Durchführung der Web-Installation (Datenbankverbindung) [cite: 129]

== 5. Sicherheit und Verschlüsselung

=== 5.1. HTTPS mit Let's Encrypt (Certbot)
[cite_start]Da es sich um eine lokale Testumgebung (Staging) ohne öffentliche Domain handelt, wurde wie in der Aufgabenstellung [cite: 31] beschrieben, ein selbstsigniertes Zertifikat (Self-Signed Certificate) anstelle von Let's Encrypt verwendet.

[source,bash]
----
# SSL-Verzeichnis erstellt
sudo mkdir /etc/nginx/ssl

# 365 Tage gültiges Zertifikat und Schlüssel erstellt
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
 -keyout /etc/nginx/ssl/nextcloud.key \
 -out /etc/nginx/ssl/nextcloud.crt \
 -subj "/C=DE/ST=Saxony/L=Dresden/O=MyOrg/CN=192.168.64.2"
----

=== 5.2. HTTPS-Erzwingung und HTTP/2
[cite_start]Die Nginx-Konfiguration (`nextcloud.conf`) wurde aktualisiert, um SSL/TLS zu aktivieren und HTTP/2 zu nutzen[cite: 30]. [cite_start]Alle Anfragen an Port 80 (HTTP) werden automatisch mittels `return 301` auf Port 443 (HTTPS) umgeleitet, wie gefordert[cite: 30].

Die aktualisierte Nginx-Konfiguration ist in Anhang 10.1 zu finden.

[source,bash]
----
sudo nano /etc/nginx/sites-available/nextcloud.conf
sudo nginx -t
sudo systemctl restart nginx
----
Der Browser zeigt bei `https://192.168.64.2` erwartungsgemäß eine Warnung an (da selbstsigniert), die Verbindung ist jedoch verschlüsselt.

=== 5.3. Nextcloud Interne Verschlüsselung
// Dieser Abschnitt wird in einer späteren Phase ausgefüllt.

== 6. Benutzer- und Datenmanagement (Intern)

=== 6.1. Benutzer und Gruppen
// Erstellte Gruppen: sales, support, management [cite: 136]
// Erstellte Benutzer: user01...user20 [cite: 135]

=== 6.2. Ordnerstrukturen und Freigaben
// Beschreibung der implementierten Ordnerstruktur [cite: 137, 140]

== 7. Backup- und Wiederherstellungsstrategie

=== 7.1. Backup-Skript (backup_nextcloud.sh)
// Vollständiges Bash-Skript hier einfügen [cite: 142]
// - Stoppen des Webservers [cite: 143]
// - Sichern von /var/www/nextcloud [cite: 144]
// - Sichern der Datenbank (mysqldump) [cite: 145]
// - Starten des Webservers [cite: 146]
// - Löschen alter Backups (älter als 14 Tage) [cite: 147]

=== 7.2. Automatisierung (Cron-Job)
// Crontab-Eintrag für die tägliche Ausführung [cite: 148]

=== 7.3. Dokumentation des Wiederherstellungstests
// Schritt-für-Schritt-Anleitung zur Wiederherstellung auf einer Testinstanz [cite: 149]

== 8. Monitoring und Logging

=== 8.1. Monitoring-Agent
// Installation und Konfiguration (z.B. Prometheus Node Exporter) [cite: 151]
// Überwachte Metriken [cite: 152, 153]

=== 8.2. Zentralisiertes Logging
// Konfiguration von rsyslog zur Weiterleitung an Graylog [cite: 154]
// Wichtige Suchanfragen (z.B. 5xx-Statuscodes) [cite: 155]

=== 8.3. Alarmierung
// Konfiguration der Benachrichtigungen (E-Mail/Slack) [cite: 156]

== 9. Performance-Optimierung (Optional)

=== 9.1. Caching (Redis/APCu)
// Konfigurationsschritte und Einträge in config.php [cite: 158]

=== 9.2. Reverse Proxy und Gzip
// Implementierungsdetails [cite: 159]

=== 10.1. Nginx Server Block (nextcloud.conf)
[cite_start]Dies ist die endgültige Konfiguration, die HTTPS (Port 443) mit einem selbstsignierten Zertifikat bereitstellt und HTTP (Port 80) auf HTTPS umleitet[cite: 19, 30].

[source,nginx]
----
# HTTP (80) Server -> HTTPS 
server {
    listen 80;
    listen [::]:80;
    server_name 192.168.64.2;
    

    return 301 https://$host$request_uri;
}

# HTTPS (443) -> Nextcloud 
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name 192.168.64.2;

    # SSL Einstellung / Zertifikat Verscjüllselung
    ssl_certificate /etc/nginx/ssl/nextcloud.crt;
    ssl_certificate_key /etc/nginx/ssl/nextcloud.key;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # Nextcloud 
    root /var/www/nextcloud;
    index index.php index.html /index.php$request_uri;

    access_log /var/log/nginx/nextcloud.access.log;
    error_log /var/log/nginx/nextcloud.error.log;

    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options "SAMEORIGIN";

    client_max_body_size 512M;

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location ~ ^\/(?:build|tests|config|lib|3rdparty|templates|data)\/ {
        deny all;
    }
    location ~ ^\/(?:\.|autotest|occ|issue|indie|db_|console) {
        deny all;
    }

    location ~ \.php(?:$|\/) {
        fastcgi_split_path_info ^(.+?\.php)(\/.*|)$;
        set $path_info $fastcgi_path_info;
        try_files $fastcgi_script_name =404;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param modHeadersAvailable true;
        fastcgi_param front_controller_active true;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_intercept_errors on;
        fastcgi_request_buffering off;
    }
}
----





